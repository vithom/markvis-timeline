<!DOCTYPE html>
<html>
<head>
    <title>Markvis-timeline v0.14</title>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment-with-locales.min.js" integrity="sha512-4F1cxYdMiAW98oomSLaygEwmCnIP38pb4Kx70yQYqRwLVCs3DbRumfBq82T08g/4LJ/smbFGFpmeFlQgoDccgg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- <script type="text/javascript" src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vis-timeline/peer/umd/vis-timeline-graph2d.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vis-timeline/styles/vis-timeline-graph2d.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vis-data@7.1.9/peer/umd/vis-data.min.js"></script>



    <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>

    <!-- Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <!-- Google fonts -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <style type="text/css">
        :root {
            --color-ratio: 30;
            --alpha-ratio: 0.5
        }

        #source {font-family: consolas, monospace;}
        #jsonPluginInput {font-family: consolas, monospace;}

        .vis-item.vis-dot.blue { border-color: var(--bs-blue); color: var(--bs-blue);}
        .vis-item.vis-dot.indigo { border-color: var(--bs-indigo); color: var(--bs-indigo);}
        .vis-item.vis-dot.purple { border-color: var(--bs-purple); color: var(--bs-purple);}
        .vis-item.vis-dot.pink { border-color: var(--bs-pink); color: var(--bs-pink);}
        .vis-item.vis-dot.red { border-color: var(--bs-red); color: var(--bs-red);}
        .vis-item.vis-dot.orange { border-color: var(--bs-orange); color: var(--bs-orange);}
        .vis-item.vis-dot.yellow { border-color: var(--bs-yellow); color: var(--bs-yellow);}
        .vis-item.vis-dot.green { border-color: var(--bs-green); color: var(--bs-green);}
        .vis-item.vis-dot.teal { border-color: var(--bs-teal); color: var(--bs-teal);}
        .vis-item.vis-dot.cyan { border-color: var(--bs-cyan); color: var(--bs-cyan);}
        .vis-item.vis-dot.black { border-color: var(--bs-black); color: var(--bs-black);}
        .vis-item.vis-dot.white { border-color: var(--bs-white); color: var(--bs-white);}
        .vis-item.vis-dot.gray { border-color: var(--bs-gray); color: var(--bs-gray);}
        
        .vis-item.vis-range.blue { background-color: hsl(from var(--bs-blue) h s calc(l + var(--color-ratio))); border-color: var(--bs-blue); }
        .vis-item.vis-range.indigo { background-color: hsl(from var(--bs-indigo) h s calc(l + var(--color-ratio))); border-color: var(--bs-indigo); }
        .vis-item.vis-range.purple { background-color: hsl(from var(--bs-purple) h s calc(l + var(--color-ratio))); border-color: var(--bs-purple); }
        .vis-item.vis-range.pink { background-color: hsl(from var(--bs-pink) h s calc(l + var(--color-ratio))); border-color: var(--bs-pink); }
        .vis-item.vis-range.red { background-color: hsl(from var(--bs-red) h s calc(l + var(--color-ratio))); border-color: var(--bs-red); }
        .vis-item.vis-range.orange { background-color: hsl(from var(--bs-orange) h s calc(l + var(--color-ratio))); border-color: var(--bs-orange); }
        .vis-item.vis-range.yellow { background-color: hsl(from var(--bs-yellow) h s calc(l + var(--color-ratio))); border-color: var(--bs-yellow); }
        .vis-item.vis-range.green { background-color: hsl(from var(--bs-green) h s calc(l + var(--color-ratio))); border-color: var(--bs-green); }
        .vis-item.vis-range.teal { background-color: hsl(from var(--bs-teal) h s calc(l + var(--color-ratio))); border-color: var(--bs-teal); }
        .vis-item.vis-range.cyan { background-color: hsl(from var(--bs-cyan) h s calc(l + var(--color-ratio))); border-color: var(--bs-cyan); }
        .vis-item.vis-range.black { background-color: hsl(from var(--bs-black) h s calc(l + var(--color-ratio))); border-color: var(--bs-black); }
        .vis-item.vis-range.white { background-color: hsl(from var(--bs-white) h s calc(l + var(--color-ratio))); border-color: var(--bs-white); }
        .vis-item.vis-range.gray { background-color: hsl(from var(--bs-gray) h s calc(l + var(--color-ratio))); border-color: var(--bs-gray); }

        .vis-item.vis-background.blue { background-color: hsl(from var(--bs-blue) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-blue); border-width: 1px;}
        .vis-item.vis-background.indigo { background-color: hsl(from var(--bs-indigo) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-indigo); border-width: 1px;}
        .vis-item.vis-background.purple { background-color: hsl(from var(--bs-purple) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-purple); border-width: 1px;}
        .vis-item.vis-background.red { background-color: hsl(from var(--bs-red) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-red); border-width: 1px;}
        .vis-item.vis-background.orange { background-color: hsl(from var(--bs-orange) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-orange); border-width: 1px;}
        .vis-item.vis-background.yellow { background-color: hsl(from var(--bs-yellow) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-yellow); border-width: 1px;}
        .vis-item.vis-background.green { background-color: hsl(from var(--bs-green) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-green); border-width: 1px;}
        .vis-item.vis-background.teal { background-color: hsl(from var(--bs-teal) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-teal); border-width: 1px;}
        .vis-item.vis-background.cyan { background-color: hsl(from var(--bs-cyan) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-cyan); border-width: 1px;}
        .vis-item.vis-background.black { background-color: hsl(from var(--bs-black) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-black); border-width: 1px;}
        .vis-item.vis-background.white { background-color: hsl(from var(--bs-white) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-white); border-width: 1px;}
        .vis-item.vis-background.gray { background-color: hsl(from var(--bs-gray) h s calc(l + var(--color-ratio)) / var(--alpha-ratio)); border-color: var(--bs-gray); border-width: 1px;}
        
        .vis-item.vis-range.primary { background-color: var(--bs-primary-bg-subtle); }
        .vis-item.vis-range.secondary { background-color: var(--bs-secondary-bg-subtle); }
        .vis-item.vis-range.success { background-color: var(--bs-success-bg-subtle); border-color: var(--bs-success); }

        .vis-dot[class*=icon-md] { border: none; background: transparent; top: 5px !important; transform: translateX(-12px) !important;}
        .vis-dot[class*=icon-bs] { border: none; background: transparent; top: 5px !important; transform: translateX(-8px) !important;}
        
        .vis-item.even {background-color: #d5f6f366;}
        .vis-item.odd {background-color: #e3f6d566;}
        .vis-item.off {background-color: #0000; background-image: repeating-linear-gradient(-45deg,#ffffff00 0 20px,#ff000015 0 40px)}
        .vis-item.notime {background-color: #f4f6d5; border-color: #f8da97}
        
        /* alternating column backgrounds */
        .vis-time-axis .vis-grid.vis-odd { background: #f5f5f5; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-sm sticky-top bg-body-tertiary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">Markvis Timeline</span>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarSupportedContent">
                <div class="navbar-nav gap-2">
                    <button class="btn btn-outline-secondary d-flex gap-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#drawer"><span class="material-icons">edit_calendar</span> Edit timeline</button>
                    <button class="btn btn-outline-success d-flex gap-1" type="button" id="btn-export"><span class="material-icons">download</span>Export</button>
                </div>
                <div class="navbar-nav gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-zoom-in"></i> Zoom</button>
                        <ul class="dropdown-menu" id="menu-zoom">
                            <li><button class="dropdown-item" type="button" id="menu_zoom_default">Default (2 weeks)</button></li>
                            <li><button class="dropdown-item" type="button" id="menu_zoom_pi">PI (10 weeks)</button></li>
                            <li><button class="dropdown-item" type="button" id="menu_zoom_semester">Semester</button></li>
                            <li><button class="dropdown-item" type="button" id="menu_zoom_year">Year</button></li>
                            <li><button class="dropdown-item" type="button" id="menu_zoom_fit">Fit all items</button></li>
                        </ul>
                    </div>
                    <div class="btn-group">
                        <!-- <button class="btn btn-primary" type="button"><i class="bi bi-calendar4-range"></i> Auto scale</button> -->
                        <!-- <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false"><span class="visually-hidden">Toggle Dropdown</span></button> -->
                        <button type="button" class="btn btn-outline-primary dropdown-toggle"  data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-calendar4-range"></i> Scale</button>
                        <ul class="dropdown-menu" id="menu-scale">
                            <li><button class="dropdown-item" type="button" id="menu_scale_auto">Auto</button></li>
                            <li><button class="dropdown-item" type="button" id="menu_scale_weeks">Weeks forced</button></li>
                            <li><button class="dropdown-item" type="button" id="menu_scale_days">Days forced</button></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><div class="form-check form-switch mx-2">
                                <input class="form-check-input" type="checkbox" id="weekscale" checked />
                                <label class="form-check-label" for="weekscale" id="weekscale_label">showWeekScale</label>
                            </div></li>
                        </ul>
                    </div>
                </div>
                <div class="navbar-nav">
                    <button class="btn btn-outline-secondary me-1 d-flex gap-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#drawerPlugins"><span class="material-icons">extension</span>Plugins</button>
                    <button class="btn btn-outline-primary me-1 d-flex gap-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#drawerConfig"><span class="material-icons">settings</span>Configuration</button>
                </div>
            </div>
        </div>
    </nav>

    <section>
        <div id="timeline"></div>
    </section>

    <div class="offcanvas offcanvas-start" id="drawer" style="width: 600px;">
        <div class="offcanvas-header">
            <h2>Timeline content</h2>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column pt-0">
            <!-- style="width:100%" -->
            <div class="d-flex mb-1">
                <input type="file" class="form-control form-control-sm" id="inputFile">
                <button type="button" class="btn btn-outline-secondary btn-sm disabled ms-1" id="btn-import">Import</button>
            </div>
            <div class="d-flex justify-content-center mb-1">
                <button type="button" class="btn btn-sm btn-outline-primary w-50" id="btn-update">Update the timeline</button>
            </div>
            <textarea id="source" class="flex-fill mb-1" placeholder="Enter syntax here"></textarea>
            
            <div id="source-config">
                <button id='btn-config-wrap' class="btn active btn-sm" data-bs-toggle="button" aria-pressed="true">autowrap</button>
                <div class="btn-group dropup">
                    <button id='btn-config-group' class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Groups</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="el-config-group"># first level group</a></li>
                        <li><a class="dropdown-item" href="#" id="el-config-group2">## Second level group</a></li>
                        <li><a class="dropdown-item" href="#" id="el-config-group3">### Third level group</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="el-config-subgroup">Subgroup</a></li>
                    </ul>
                </div>
                <div class="btn-group dropup">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Items</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" id="el-config-item-point">. point item</a></li>
                        <li><a class="dropdown-item" href="#" id="el-config-item-icon">*icon item with icon (google material icons)</a></li>
                        <li><a class="dropdown-item" href="#" id="el-config-item-icon2">{icon} item with icon (Bootstrap icons)</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="el-config-item-box">! box item</a></li>
                        <li><a class="dropdown-item" href="#" id="el-config-item-range">] range item</a></li>
                        <li><a class="dropdown-item" href="#" id="el-config-item-background">= background item</a></li>
                        <li><a class="dropdown-item" href="#" id="el-config-item-recursive">¤ recursive items</a></li>
                    </ul>
                </div>
                <div class="btn-group dropup">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">Icons catalog</button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="https://fonts.google.com/icons?icon.set=Material+Icons" target="_blank">Google Material icons</a></li>
                        <li><a class="dropdown-item" href="https://icons.getbootstrap.com/" target="_blank">Bootstrap icons</a></li>
                    </ul>
                </div>
            </div>
            <!-- TODO: investigate further -->
            <!-- <div contenteditable="true">test</div> -->
        </div>
    </div>

    <div class="offcanvas offcanvas-end" id="drawerConfig" data-bs-backdrop="false" style="width: 500px;">
        <div class="offcanvas-header">
            <h3>Configuration</h3>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="form-check form-switch mb-2">
                <input class="form-check-input" type="checkbox" role="switch" id="switch-dev-mode">
                <label class="form-check-label" for="switch-dev-mode">Dev mode (editable on)</label>
            </div>

            <div class="card mb-2">
                <div class="card-header">Groups configuration</div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="stack" checked />
                        <label class="form-check-label" for="stack">stack</label>
                    </div>
                    
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="stackSubgroups" checked />
                        <label class="form-check-label" for="stackSubgroups">stackSubgroups</label>
                    </div>
                </div>
            </div>

            <div class="card mb-2">
                <div class="card-header">timeline layout</div>
                <div class="card-body">
                    <!-- <button id='btn_export'>Test export</button> -->
                    <button class="form-control mb-2" id='btn_restore'>Restore all groups visibility</button>
                    
                    <label for="opt-timeline-groupFoldedLevel" class="form-label">Groups level folded by default: <span>0</span></label>
                    <input type="range" class="form-range" min="0" max="3" step="1" value="0" id="opt-timeline-groupFoldedLevel">
                    
                    <div class="list-group list-group-horizontal">
                        <button type="button" class="list-group-item list-group-item-action" id="opt-timeline-foldAllGroups">Fold all groups</button>
                        <button type="button" class="list-group-item list-group-item-action" id="opt-timeline-unfoldAllGroups">Unfold all groups</button>
                    </div>
                </div>
            </div>

            <div class="card mb-2">
                <div class="card-header">Locale</div>
                <div class="card-body">
                    <div class="form-check">
                        <label class="form-check-label">
                            <input type="radio" name="locale" class="form-check-input" value="en_GB" checked />
                            English (GB, Monday 1st day of the week)
                        </label>
                    </div>
                    
                    <div class="form-check">
                        <label class="form-check-label">
                            <input type="radio" name="locale" class="form-check-input" value="fr" />
                            French
                        </label>
                    </div>

                    <div class="form-check">
                        <label class="form-check-label">
                            <input type="radio" name="locale" class="form-check-input" value="en_US" />
                            English (US, Sunday 1st day of the week)
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="offcanvas offcanvas-bottom" id="drawerPlugins" data-bs-backdrop="false" style="height: 600px;">
        <div class="offcanvas-header p-2">
            <h3>Plugins</h3>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body d-flex flex-column">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-plugin-json" type="button" aria-controls="tab-plugin-json" aria-selected="true">
                        Json to items <a href="https://github.com/vithom/markvis-timeline?tab=readme-ov-file#json-plugin" target="_blank"><i class="bi bi-question-circle"></i></a>
                    </button>
                    
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-plugin-api" type="button" aria-controls="tab-plugin-api" aria-selected="true">
                        API call to items <a href="https://github.com/vithom/markvis-timeline?tab=readme-ov-file#api-plugin" target="_blank"><i class="bi bi-question-circle"></i></a>
                    </button>
                </li>
            </ul>

            <div class="tab-content p-2 border border-top-0 flex-grow-1">
                <div class="tab-pane h-100 active" id="tab-plugin-json">
                    <div class="container-fluid h-100">
                        <div class="row h-100">
                            <div class="col d-flex flex-column gap-3">
                                <div class="mb-2">
                                    <div class="form-text">Group where to add the items</div>
                                    <input type="text" id="inputGroup" class="form-control">
                                
                                    <div class="form-text">Json key for items' title</div>
                                    <input type="text" id="inputContent" class="form-control">
                                
                                    <div class="form-text">Json key for items' date</div>
                                    <input type="text" id="inputDate" class="form-control">
                                
                                    <div class="form-text">Optional regexps to evaluate on the date field (<a href="https://regex101.com/" target="_blank">help</a>)</div>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="inputRegexpDate" placeholder="Date/time regexp">
                                        <span class="input-group-text">T</span>
                                        <input type="text" class="form-control" id="inputRegexpTime" placeholder="Time specific regexp" aria-label="time specific regexp">
                                    </div>
                                </div>
                                <div class="d-flex align-items-baseline">
                                    <button type="submit" class="btn btn-primary" id="buttonJsonPlugin">Submit</button>
                                    <div class="form-text ms-3" id="pluginJsonResult">The json must be an array of objects with at least the keys for the content and the date</div>
                                </div>
                            </div>
                            <div class="col d-flex flex-column">
                                <textarea class="form-control flex-grow-1" id="jsonPluginInput" aria-label="With textarea" placeholder="paste json content here..."></textarea>
                                <div class="invalid-feedback">Please paste valid json content</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane h-100" id="tab-plugin-api">
                    <div class="container-fluid h-100">
                        <div class="row h-100">
                            <div class="col d-flex flex-column gap-3">
                                <div>
                                    <div class="form-text">Group where to add the items</div>
                                    <input type="text" id="plugin-api-group-input" class="form-control">
                                    <div class="form-text">Json key for items' title</div>
                                    <input type="text" id="plugin-api-inputTitle" class="form-control">
                                    <div class="form-text">Json key for items' date</div>
                                    <input type="text" id="plugin-api-inputDate" class="form-control">
                                </div>
                                <div class="d-flex" style="gap: 20px;">
                                    <div class="form-text">Item config</div>
                                    <div class="btn-group" role="group" aria-label="Item type">
                                        <input type="radio" class="btn-check" name="plugin-api-item-type" id="plugin-api-item-type-point" value="point" autocomplete="off" checked>
                                        <label class="btn btn-outline-primary btn-sm" for="plugin-api-item-type-point">Point</label>

                                        <input type="radio" class="btn-check" name="plugin-api-item-type" id="plugin-api-item-type-box" value="box" autocomplete="off">
                                        <label class="btn btn-outline-primary btn-sm" for="plugin-api-item-type-box">Box</label>

                                        <input type="radio" class="btn-check" name="plugin-api-item-type" id="plugin-api-item-type-range" value="range" autocomplete="off" disabled>
                                        <label class="btn btn-outline-primary btn-sm" for="plugin-api-item-type-range">Range</label>

                                        <input type="radio" class="btn-check" name="plugin-api-item-type" id="plugin-api-item-type-background" value="background" autocomplete="off" disabled>
                                        <label class="btn btn-outline-primary btn-sm" for="plugin-api-item-type-background">Background</label>
                                    </div>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary" id="plugin-api-submit">Submit</button>
                                </div>
                            </div>
                            <div class="col d-flex flex-column">
                                <div class="form-text">API endpoint (GET request)</div>
                                <input type="text" id="plugin-api-endpoint" class="form-control">
                                <div class="form-text">Logs</div>
                                <textarea class="form-control flex-grow-1" id="plugin-api-output" style="height: 300px;" aria-label="With textarea" wrap="off" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        
        class Markvis {

            // Possible symbols
            // # ~ & { } [ ] | - ` _ \ ^ @ ( ) = + $ £ ¤ * µ % § ! / : ; . , ? < >
            static SYNTAX =  Object.freeze({
                CHAR_GROUP: '#',
                CHAR_SUBGROUP: '(',
                CHAR_SUBGROUP_END: ')',
                CHAR_EVENT_POINT: '.',
                CHAR_EVENT_BOX: '!',
                CHAR_EVENT_RANGE: ']',
                CHAR_EVENT_BACKGROUND: '=',
                CHAR_EVENT_RECURSIVE: '¤',
                CHAR_ICON_GOOGLE: "*",
                CHAR_ICON_BOOTSTRAP: "{}",
                CHAR_SEPARATOR_DATE: "/",
                CHAR_SEPARATOR_COLOR: "|",
                CHAR_COMMENT: '//',
                CHAR_RAW_ITEM: '&'
            })

            constructor() {
                // this.groups = new vis.DataSet()

                this.groups = {
                    dataset: new vis.DataSet(),

                    // Use of arrow function to keep the context of 'this'
                    add: (line, level) => {
                        const re = new RegExp(/([^;|]+)\s*(?:;?([^|]+))?(?:\|?\s*(\w+))?/)
                        const matches = re.exec(line)

                        if (matches) {
                            const content = matches[1].trim()
                            const id = matches[2] ? matches[2].trim() : null
                            const color = matches[3] ? matches[3].trim() : null

                            let it = { content: content, value: this.currentSubgroupValue++ }
                            if (id) { it.id = id }
                            if (color) { it.className = color }

                            if (level > 0) { it.treeLevel = level }

                            if (level >= this.configuration.groupsLevelFoldedByDefault) {
                                it.showNested = false
                            }

                            const groupId = this.groups.dataset.add(it)

                            if (level > 0) {
                                const parent = this.groups.dataset.get(this.breadcrumb[level-1])

                                if (parent.nestedGroups == undefined) { parent.nestedGroups = [] }
                                parent.nestedGroups.push(groupId[0])
                            }

                            if (level == 0) { this.breadcrumb.length = 1 } // resets the tab to 1 element and delete all other elements

                            this.breadcrumb[level] = groupId[0]
                            this.currentGroupColor = color
                            
                            this.currentGroupId = groupId[0]
                        }
                        else {
                            console.warn("no regexp match for group:", line)
                        }
                    },

                    foldAll: () => {
                        this.groups.dataset.forEach(function(group) {
                                group.showNested = false
                        })
                        timeline.setGroups(this.groups.dataset)
                    },
                    
                    unfoldAll: () => {
                        this.groups.dataset.forEach(function(group) {
                            if (group.nestedGroups) {
                                group.showNested = true
                            }
                            group.visible = true
                        })
                        timeline.setGroups(this.groups.dataset)
                    },

                }
                
                this.items = new vis.DataSet()
                
                this.options = {
                    start: luxon.DateTime.now().minus({days: 1}).toISO(),
                    end: luxon.DateTime.now().plus({weeks: 2}).toISO(),
                    //horizontalScroll: true,
                    // maxHeight: 750,
                    //timeAxis: { scale: 'week' },
                    zoomKey: "ctrlKey",
                    verticalScroll: true,
                    locale: 'en_GB',
                    showWeekScale: true,
                    orientation: 'top',
                    zoomMin: 1000*60*60*24*7, // 1 week in ms
                    zoomMax: 1000*60*60*24*7*52*5, // 5 years in ms
                    type: 'point',
                    //editable: true,
                    groupEditable: true,
                    xss: {disabled: true},

                    groupOrder: function(a,b) {
                        return a.value - b.value;
                    },
                    
                    groupOrderSwap: function (a, b, groups) {
                        // console.log("groupOrderSwap called:", a, b, groups)
                        let v = a.value;
                        a.value = b.value;
                        b.value = v;
                    },
                    
                    groupTemplate: function(group) {
                        let container = document.createElement('div');
                        //container.className = "d-flex"
                        
                        let content = document.createElement('span');
                        //content.className = "flex-fill"
                        content.innerHTML = group.content+" ";
                        
                        let btn2 = document.createElement('button')
                        btn2.innerHTML = '<i class="bi bi-arrows-collapse" style="font-size: 1.2rem;"></i>'
                        btn2.className = 'btn btn-outline-secondary p-0'
                        btn2.type = 'button'
                        btn2.addEventListener('click', function() {
                            let groups = mks.groups.dataset
                            
                            groups.forEach(function(group_) {
                                if (group_.id != group.id) groups.update({id: group_.id, visible: false});
                            })
                        })
                        
                        container.append(content)
                        container.append(btn2)

                        return container
                    },
                }

                this.configuration = {
                    zoom: 'default',
                    scale: 'auto',
                    stack: true,
                    stackSubgroups: true,
                    showWeekScale: true,
                    groupsLevelFoldedByDefault: 0,
                }

                this.breadcrumb = []

                this.currentGroupId = null
                this.currentSubgroupId = null
                this.currentSubgroupValue = 0
                this.currentGroupColor = null

                //this.timeline = new vis.Timeline()
            }

            clear() {
                this.groups.dataset.clear()
                this.items.clear()
                this.breadcrumb.length = 0
                this.currentGroupId = null
                this.currentSubgroupId = null
                this.currentSubgroupValue = 0
                this.currentGroupColor = null
            }

            createItem(type = "point") {
                let item = {}
                
                item.type = type
                if (this.currentGroupId) { item.group = this.currentGroupId }
                if (this.currentSubgroupId) { item.subgroup = this.currentSubgroupId }

                return item
            }

            addItem(type, line, className = null) {
                let item =  this.createItem(type)

                let parts = line.split(Markvis.SYNTAX.CHAR_SEPARATOR_COLOR)
                
                let color = parts[1] ? parts[1].trim() : this.currentGroupColor
                
                line = parts[0]

                parts = line.split(';')
                let content = parts[0].trim()

                const [start, end] = this.extractDate(parts[1])
                
                item.content = content
                
                item.start = dt(start)
                if (type == "range" || type == "background") { item.end = dt(end) }

                // TODO: comparer si start > end => inverser
                
                if (color) { item.className = color }

                if (className) { item.className += " "+className }

                this.items.add(item)
            }

            addRecursiveItems(line) {
                const parts = line.split(Markvis.SYNTAX.CHAR_SEPARATOR_COLOR)
                
                let color = parts[1] ? parts[1].trim() : this.currentGroupColor
                
                let rest = parts[0].split(";")
                const duration = this.extractDuration(rest[2])

                let [start, end] = this.extractDate(rest[1])
                start = luxon.DateTime.fromISO(start)
                end = start.plus(duration)

                for (event of rest[0].split(',')) {
                    let it = this.createItem('background')
                    it.content = event
                    if (color) { it.className = color }
                    it.start = start.toISO()
                    it.end = end.toISO()

                    it.style="border-left-style: solid;"

                    this.items.add(it)

                    start = start.plus(duration)
                    end = end.plus(duration)
                }
            }

            extractDate(date_part) {
                const parts = date_part ? date_part.split('/') : []

                const start = parts[0] ? parts[0].trim() : null
                let end = parts[1] ? parts[1].trim() : null

                if (end && end[0] == '+') {
                    const dur = this.extractDuration(end.substr(1))
                    end = luxon.DateTime.fromISO(dt(start)).plus(dur).toISO()
                }

                return [start, end]
            }

            extractDuration(duration) {
                const matches = [...duration.matchAll(/(\d+)([hdwMy])/g)]
                
                let obj = (matches.length > 0) ? {} : {"days": 1}
                
                for (const m of matches) {
                    let key = "days"
                    let n = m[1]

                    if (m[2]) {
                        const map = new Map([["h", "hours"],["d","days"],["w","weeks"],["M","months"],["y", "years"]])
                        key = map.get(m[2])
                    }

                    obj[key] = n
                }

                return obj
            }

            defaultZoom() {
                $("#menu_zoom_default").click()
            }
        }
    </script>

    <script type="text/javascript">
        //TODO:
        
        // Content drawer //
        // + maybe change the textarea to a contenteditable div like codemirror/ace/monaco
        // + Add color helper
        // + add possibility to write a HTML color name
        // + add new icon provider : material design icons + syntax to chose the provider ie. {provider-1-letter/icon}
        // + group closed by default (syntax ?)
        // + Add a syntax for comments on an item (tootip content)
        // + add a syntax to avoid a line to be re-ordered ?
        
        // Timeline
        // + Tooptip for group button (only display this line) ?
        // + Add a button to put the line on top ?
        // + To have a custom function (format in the options) to manage display of timeline scale
        //     => have multiple options in the Scale menu
        //        - days forced + weeks above
        // + explore clustering feature (see exemples > others)
        
        // + Add a subgroup with none stacked items + syntax
        // + "Gantt" mode for a group (all lines are stacked in the defined order) + syntax
        
        // Range items
        // + selector/sign to display text outside the range
        // + change the date syntax : maybe <start>:<end> => only one date field (refactoring needed)
        
        // Icons items
        // unify the syntax for providers : only surrounded signs or not
        
        // Plugins
        // + Add a plugin to link with github gist
        // + Add a plugin to link with google drive ??? // proposed by @copilot
        // JSON plugin : add a way to add/clear items (maybe by group ??)
        // JSON/API : possibility to create the group if it is not there ?
        
        // Dev mode
        // + add possibility to rename items
        
        // + Internal refactoring for the Markvis class
        //   ++ integrate the timeline in the class
        //   ++ integrate the helpers functions in the class

        //BUGS:
        // - icons not always displayed the first time
        // - space between icon and text too big the first time
        // => use a template ?
        // => or with a callback event when the item appears or timeline move (see exemples)

        const $ = (sel) => document.querySelector(sel) // jQuery emulation

        $("#weekscale_label").onclick = function(e) {e.stopPropagation()}

        function analyze(line) { //TODO : a mettre dans la classe Markvis
            // TODO: use regexp ?
            const re = new RegExp(/\#{1}\s*(.+);\s*(.+)/g)

            const matches = re.exec(line)
            console.debug(matches)

            if (line.startsWith(Markvis.SYNTAX.CHAR_COMMENT)) {
                console.log("comment found:", line.substr(2))
                return
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_GROUP + Markvis.SYNTAX.CHAR_GROUP + Markvis.SYNTAX.CHAR_GROUP)) {
                mks.groups.add(line.substr(3).trim(), 2)
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_GROUP + Markvis.SYNTAX.CHAR_GROUP)) {
                mks.groups.add(line.substr(2).trim(), 1)
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_GROUP))
            {
                mks.groups.add(line.substr(1).trim(), 0)
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_SUBGROUP))
            {
                mks.currentSubgroupId = line.substr(1).trim()
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_SUBGROUP_END))
            {
                let currentGroupId = mks.currentGroupId
                mks.groups.dataset.get(currentGroupId).subgroupStack = true
                mks.currentSubgroupId = null
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_EVENT_POINT))
            {
                mks.addItem("point", line.substr(1).trim())
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_ICON_GOOGLE))
            {

                // const re = new RegExp(/\*(\w+)? ([^;|]+)(;\s*([^|]+)\s*)?(\|\s*(\w+))?/)
                const re = new RegExp(/\*(\w+)? (.+)/)
                const matches = re.exec(line)

                console.log(matches)
                
                if (matches) {
                    const icon = matches[1]
                    const line = matches[2]

                    const className = icon ? 'vis-icon icon-md-'+icon : icon

                    mks.addItem("point", line, className)
                }
                else {
                    console.warn("no regexp match for", line)
                }

            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_ICON_BOOTSTRAP[0]))
            {
                const re = new RegExp(/{([\w-]+)} (.+)/)
                const matches = re.exec(line)

                if (matches) {
                    const icon = matches[1]
                    const line = matches[2]

                    const className = icon ? 'vis-icon icon-bs-'+icon : icon

                    mks.addItem("point", line, className)
                }
                else {
                    console.warn("no regexp match for", line)
                }
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_EVENT_BOX))
            {
                mks.addItem("box", line.substr(1).trim())
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_EVENT_BACKGROUND))
            {
                mks.addItem("background", line.substr(1).trim())
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_EVENT_RANGE))
            {
                mks.addItem("range", line.substr(1).trim())
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_EVENT_RECURSIVE)) {
                
                mks.addRecursiveItems(line.substr(1).trim())
            }
            else if (line.startsWith(Markvis.SYNTAX.CHAR_RAW_ITEM)) {
                item = JSON.parse(line.substr(1))
                
                if(!item.hasOwnProperty("group")) { item['group'] = mks.currentGroupId }
                
                mks.items.add(item)
            }
            else {
                //TODO: afficher les erreurs
                // ici lignes non traitées
                console.warn('Line not interpreted', line)
            }
        }

        document.getElementById('btn-update').onclick = function() {
            mks.clear()

            md_content = document.getElementById('source').value

            for (line of md_content.trim().split("\n")) {
                if (line.length > 0) {
                    analyze(line.trim())
                }
            }
            
            timeline.setGroups(mks.groups.dataset)
            timeline.setItems(mks.items)

            // Removed the update of the zoom here
            // mks.defaultZoom()

            // Update for icon here
            // DOM manipulation only available after timeline.setItems()
            const nodes = document.querySelectorAll(".vis-dot.vis-icon")
            nodes.forEach((it) => {
                let icon = "star"
                
                it.classList.forEach((name) => {
                    
                    if (name.startsWith('icon-bs-')) // Bootstrap icons
                    {
                        icon = name.split("icon-bs-")[1]
                        it.innerHTML ='<i class="bi bi-'+icon+'"></i>'
                    }
                    else if (name.startsWith("icon-md-")) // Google Material icons
                    {
                        icon = name.split("icon-md-")[1]
                it.innerHTML ='<span class="material-icons">'+icon+'</span>'
                    }
                })
            })
        }
        
        $('#btn-import').onclick = function() {
            const selectedFile = document.getElementById("inputFile").files[0];
            const r = new FileReader()
            r.onload = function() {
                document.getElementById('source').value = this.result
            }
            r.readAsText(selectedFile)
        }

        
        $('#btn-export').onclick = function() {
            const selectedFile = document.getElementById("inputFile").files[0];
            let filename = "export.md"
            
            if (selectedFile) {
                filename = selectedFile.name
            }
            
            const text = document.getElementById('source').value
            const file = new File([text], filename)
            const url = URL.createObjectURL(file);

            let link = document.createElement('a');
            link.href = url
            link.download = file.name;
            link.click();
            URL.revokeObjectURL(url);
        }

        $('#inputFile').addEventListener("change", function(){
            if (this.files.length == 1) {
                document.getElementById('btn-import').classList.remove('disabled')
            } else {
                document.getElementById('btn-import').classList.add('disabled')
            }
        })

        $('#btn-config-wrap').onclick = function () {
            let isPressed = Boolean(this.getAttribute("aria-pressed") == "true")
            let textarea = document.getElementById("source")

            if (isPressed) {
                textarea.setAttribute("wrap", 'soft')
            } else {
                textarea.setAttribute("wrap", 'off')
            }
        }

        $("#el-config-group").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_GROUP + " title\n")
        $("#el-config-group2").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_GROUP + Markvis.SYNTAX.CHAR_GROUP +" title\n")
        $("#el-config-group3").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_GROUP + Markvis.SYNTAX.CHAR_GROUP + Markvis.SYNTAX.CHAR_GROUP +" title\n")
        $("#el-config-item-point").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_EVENT_POINT + " title ; date\n")
        $("#el-config-item-icon").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_ICON_GOOGLE + "star title ; date\n")
        $("#el-config-item-icon2").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_ICON_BOOTSTRAP[0] + "star" + Markvis.SYNTAX.CHAR_ICON_BOOTSTRAP[1] + " title ; date\n")
        $("#el-config-item-box").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_EVENT_BOX + " title ; date\n")
        $("#el-config-item-range").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_EVENT_RANGE + " title ; date_Start ; date_End\n")
        $("#el-config-item-background").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_EVENT_BACKGROUND + " title ; date_Start ; date_End\n")
        $("#el-config-item-recursive").onclick = ()=> insertAtCursorPosition(Markvis.SYNTAX.CHAR_EVENT_RECURSIVE)

        function insertAtCursorPosition(text) {
            let it = $("#source")
            const [start, end] = [it.selectionStart, it.selectionEnd]
            console.log(start, end)
            it.setRangeText(text, start, end)
        }

        $("#switch-dev-mode").onchange = function() {
            if (this.checked) {
                timeline.setOptions({editable: true})
            } else {
                timeline.setOptions({editable: false})
            }
        }


    </script>

    <script type="text/javascript">
        //
        // MAIN SCRIPT
        //
        
        if (localStorage.getItem('timeline')) {
            console.log(localStorage.getItem('timeline'));
        } else {
            console.log('pas de local storage pour la timeline')
        }

        var dt = function(datetime) {
            it = datetime ? luxon.DateTime.fromISO(datetime.trim()).toISO() : luxon.DateTime.now().toISO()
            if (it == null) {
                it = luxon.DateTime.now().toISO()
            }
            return it
        };

        // ***  functions for the dataset ***

        // function point(group, content, start) {
        //     return {
        //         group: group,
        //         content: content,
        //         start: dt(start)
        //     }
        // }

        // function box(group, content, start) {
        //     return {
        //         group: group,
        //         content: content,
        //         start: dt(start),
        //         type: 'box'
        //     }
        // }

        // function range(group, content, start, end) {
        //     return {
        //         group: group,
        //         content: content,
        //         start: dt(start),
        //         end: dt(end),
        //         type: 'range'
        //     };
        // }

        // function background(group, content, start, end) {
        //     return {
        //         group: group,
        //         content: content,
        //         start: dt(start),
        //         end: dt(end),
        //         type: 'background'
        //     };
        // }

        // *** functions for items display ***

        // No used by this version
        //
        // function table_block(group, table, date) {
        //     return {
        //         group: group,
        //         content: table_block2("Start of production", table),
        //         start: dt(date),
        //         type: 'box'
        //     }
        // }

        // function table_block2(title, table) {
        //     let res = `
        //     <div class="card lm-1">
        //         <div class="card-header py-1">${title}</div>
        //         <div class="card-body py-0">
        //             <table class="table table-sm m-0">`;
        //     for (item of table) {
        //         res += `<tr><th class="text-end">${item[0]} :</th><td class="text-end">${item[1]}</td></tr>`
        //     }

        //     res += `</table></div></div>`

        //     return res
        // }
        
        var container = document.getElementById('timeline');

        //Code timeline swconfigurator/crisp
        
        /*this.visTimelineService.setOptions(this.visTimeline, {
                        start: V[0].start,
                        showWeekScale: !0,
                        stack: this._stack,
                        template: this.templateFunction.bind(this),
                        orientation: "top",
                        height: "100%"
                    }),*/

        const mks = new Markvis();

        // TODO: integrate in Markvis class
        var timeline = new vis.Timeline(container, mks.items, mks.groups.dataset, mks.options);

        //
        // Configuration drawer callbacks
        //

        for(el of document.querySelectorAll("#menu-scale>li>button")) {
            el.onclick = function() {
                const map = {
                    menu_scale_weeks: "week",
                    menu_scale_days: "day",
                }
                timeline.setOptions({ timeAxis: {scale: map[this.id]} });
            };
        }


        for (el of document.querySelectorAll("#menu-zoom>li>button")) {
            el.onclick = function() {
                if (this.id == "menu_zoom_fit") {
                    timeline.fit()
                } else {
                    const map = {
                        menu_zoom_default: {weeks: 2},
                        menu_zoom_pi: {weeks: 10},
                        menu_zoom_semester: {months: 6},
                        menu_zoom_year: {years: 1}
                    }
                    // console.log("map:", this.id, map[this.id])
                    timeline.setWindow(
                        luxon.DateTime.now().minus({days: 1}).toISO(),
                        luxon.DateTime.now().plus(map[this.id]).toISO()
                    )
                }
            }
        }

        $('#weekscale').onchange = function() {
            mks.configuration.showWeekScale = this.checked
            timeline.setOptions({showWeekScale: this.checked});
        }

        function zoomOutToWeekScale() {
            if (timeline.timeAxis.step.scale == "day") {
                console.log('zoom again 2');
                timeline.zoomOut(0.2, {animation:false}, zoomOutToWeekScale);
            }
        }

        for(el of document.querySelectorAll("input[name='locale']")) {
            el.onchange = function() {
                timeline.setOptions({ locale: this.value });
            };
        }

        $("#stack").onchange = function () {
            mks.configuration.stack = this.checked
            timeline.setOptions({stack: this.checked})
        }

        $("#stackSubgroups").onchange = function () {
            mks.configuration.stackSubgroups = this.checked
            timeline.setOptions({stackSubgroups: this.checked})
        }

        // Timeline layout options

        $('#btn_restore').onclick = function() {
            let groups = mks.groups.dataset
            
            groups.forEach(function(group) {
                groups.update({id: group.id, visible: true});
            })
        }

        $("#opt-timeline-groupFoldedLevel").onchange = function () {
            mks.configuration.groupsLevelFoldedByDefault = this.value
            this.previousElementSibling.firstElementChild.innerText = this.value
        }

        $("#opt-timeline-foldAllGroups").onclick = function () {
            mks.groups.foldAll()
        }
        $("#opt-timeline-unfoldAllGroups").onclick = function () {
            mks.groups.unfoldAll()
        }

        //
        // End of configuration drawer callbacks
        //

        // timeline.on('rangechange', function(props){
        //     console.log('rangechange: '+props.items);
        // });
        timeline.on('rangechanged', function(props){
            console.log('rangechanged:', timeline.timeAxis.step.scale);
            // console.log(props);
        });

        function checkEmptyField(field) {
            if (!$(field).value.trim()) {
                $(field).classList.add("is-invalid")
                return true
            } else {
                $(field).classList.remove("is-invalid")
                return false
            }
        }

        $("#buttonJsonPlugin").onclick = function() {
            const group = $("#inputGroup").value.trim()
            const keyContent = $("#inputContent").value.trim()
            const keyDate = $("#inputDate").value.trim()
            const regexpDate = $("#inputRegexpDate").value  //no trim as we may want a space at the begining/end of the regexp
            const regexpTime = $("#inputRegexpTime").value  //no trim as we may want a space at the begining/end of the regexp
            const jsonContent = $("#jsonPluginInput").value
            
            let isError = false

            const jsonOutput = (text => {
                $("#jsonPluginInput").classList.add("is-invalid")
                $("#jsonPluginInput~div").innerText = text
            })
            
            isError |= checkEmptyField("#inputGroup")
            isError |= checkEmptyField("#inputContent")
            isError |= checkEmptyField("#inputDate")
            isError |= checkEmptyField("#jsonPluginInput")

            if (isError) { return }

            try {
                var json = JSON.parse(jsonContent)
            } catch (error) {
                jsonOutput(error.message)
                return
            }

            if (! Array.isArray(json) || (Array.isArray(json) && json.length == 0) ) {
                jsonOutput("The json must be an array of objects")
                return
            }
            
            json.forEach(item => {
                const content = item[keyContent]
                let date = item[keyDate]

                if (regexpDate) {
                    const re = new RegExp(regexpDate)
                    const matches = re.exec(date)

                    if (regexpTime) {
                        const reTime = new RegExp(regexpTime);
                        const matchesTime = reTime.exec(date);
                        
                        if (matches && matchesTime) {
                            date = matches?.[1] + 'T' + matchesTime?.[1];
                        } else {
                            date = ""
                        }
                    } else {
                        date = matches?.[1] ?? ""
                    }
                }

                if (content) { mks.items.add({group: group, content: content, start: dt(date)}) }
            })
        }

        $("#plugin-api-submit").onclick = function() {
            const url = $("#plugin-api-endpoint").value.trim()

            $("#plugin-api-output").value = ""

            let isError = false
            
            isError |= checkEmptyField("#plugin-api-endpoint")
            isError |= checkEmptyField("#plugin-api-group-input")
            isError |= checkEmptyField("#plugin-api-inputTitle")
            isError |= checkEmptyField("#plugin-api-inputDate")

            if (isError) { return }
            
            $("#plugin-api-submit").innerHTML = 'Submit<span class="spinner-border spinner-border-sm ms-2" aria-hidden="true"></span>'
            
            fetch(url)
                .then(response => response.json())
                .then(json => insert_items_from_json(json))
                .catch(error => $("#plugin-api-output").value = "Error: " + error.message)
                .finally(() => $("#plugin-api-submit").innerHTML = 'Submit')
        }

        function insert_items_from_json(json) {
            console.log("Response received from API:", json)

            const group = $("#plugin-api-group-input").value.trim()
            const content_key = $("#plugin-api-inputTitle").value.trim()
            const date_key = $("#plugin-api-inputDate").value.trim()
            const item_type = $("input[name='plugin-api-item-type']:checked").value
            
            json.forEach(item => {
                const content = item[content_key]
                const date = item[date_key]

                $("#plugin-api-output").value += `inserting... ${content} at ${date}\n`

                mks.items.add({group: group, content: content, start: dt(date), type: item_type})
            })
        }
            

        window.addEventListener("keydown", (event) => {
            const drawer = $("#drawer")
            const minWidth = 350
            const maxWidth = window.innerWidth - 50

            if (drawer.classList.contains("show")) {
                if (event.key == "ArrowRight" && event.altKey) {
                    const newWidth = parseInt(drawer.style.width) + 50
                    if (newWidth < maxWidth) {
                        drawer.style.width = newWidth + "px"
                    }
                }
                else if (event.key == "ArrowLeft" && event.altKey) {
                    const newWidth = parseInt(drawer.style.width) - 50
                    if (newWidth > minWidth) {
                        drawer.style.width = newWidth + "px"
                    }
                }
            }
        });
    </script>
</body>
</html>